<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            color: #333;
            font-size: 14px;
        }
        .container {
            max-width: 100%;
            display: none; /* Escondido até o login */
        }
        #login-container {
            max-width: 300px;
            margin: 50px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        #totalBalance {
            font-weight: bold;
            font-size: 1.2em;
        }
        .positive { color: #2ecc71; }
        .negative { color: #e74c3c; }
        .card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            margin-top: 5px;
            cursor: pointer;
        }
        button:hover {
            opacity: 0.9;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .actions button {
            flex: 1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        .income { color: #2ecc71; }
        .expense { color: #e74c3c; }
        .paid { text-decoration: line-through; opacity: 0.7; }
        .delete-btn { background-color: #e74c3c; }
        .edit-btn { background-color: #f39c12; }
        .pay-btn { background-color: #2ecc71; }
        canvas { max-width: 100%; }
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }
        .tab-button {
            flex: 1;
            background: #ddd;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        .tab-button.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #logout-btn {
            background: #e74c3c;
            margin-top: 10px;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .category-item:last-child {
            border-bottom: none;
        }
        .category-item button {
            width: auto;
            padding: 5px 10px;
            margin-top: 0;
        }

        /* Estilos do Calendário */
        #calendar-container {
            margin-top: 20px;
            text-align: center;
        }
        #calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #calendar-header button {
            width: auto;
            padding: 5px 10px;
            margin: 0;
            background-color: #555;
        }
        #calendar-header button:hover {
            background-color: #777;
        }
        #calendar-grid {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden; /* Para bordas arredondadas */
        }
        #calendar-grid th, #calendar-grid td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: center;
            vertical-align: top;
            height: 60px; /* Altura fixa para as células */
            position: relative;
            cursor: pointer; /* Indica que é clicável */
        }
        #calendar-grid th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        #calendar-grid td.current-month {
            background-color: #fff;
        }
        #calendar-grid td.other-month {
            background-color: #f9f9f9;
            color: #bbb;
            cursor: default; /* Não clicável */
        }
        #calendar-grid td.today {
            background-color: #e0f7fa; /* Azul claro */
            border: 2px solid #00bcd4; /* Ciano */
            font-weight: bold;
        }
        #calendar-grid td.has-bill {
            background-color: #ffe0b2; /* Laranja claro */
            border: 2px solid #ff9800; /* Laranja */
            font-weight: bold;
        }
        #calendar-grid td.has-bill.today {
            background-color: #ffccbc; /* Salmão claro */
            border: 2px solid #ff5722; /* Laranja avermelhado */
        }
        .bill-indicator {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #e74c3c;
            font-weight: bold;
            white-space: nowrap; /* Evita quebra de linha */
        }

        /* Estilos do Modal de Detalhes da Conta */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
            background: none; /* Remove background padrão do botão */
            border: none; /* Remove borda padrão do botão */
            width: auto; /* Ajusta largura para o X */
            padding: 0; /* Remove padding padrão */
            margin: 0; /* Remove margin padrão */
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .bill-item {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .bill-item:last-child {
            border-bottom: none;
        }
        .bill-item strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 2px;
        }
        .bill-item span {
            color: #555;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h2 style="text-align: center;">Controle Financeiro</h2>
        <div class="form-group">
            <label for="login-password">Senha:</label>
            <input type="password" id="login-password" placeholder="Digite sua senha">
        </div>
        <button id="login-btn">Entrar</button>
        <div id="login-message" style="color: red; margin-top: 10px; text-align: center;"></div>
    </div>

    <div class="container" id="app-container">
        <header>
            <h1 style="margin:0">Controle Financeiro</h1>
            <div>Saldo: <span id="totalBalance" class="positive">R$ 0,00</span></div>
            <button id="logout-btn">Sair</button>
        </header>

        <div class="tab-buttons">
            <button class="tab-button active" data-tab="transactions">Transações</button>
            <button class="tab-button" data-tab="paid">Pagas</button>
            <button class="tab-button" data-tab="reports">Relatórios</button>
            <button class="tab-button" data-tab="categories">Categorias</button>
        </div>

        <div id="transactions" class="tab-content active">
            <div class="card">
                <h3 style="margin-top:0">Nova Transação</h3>
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="type">Tipo:</label>
                        <select id="type" required>
                            <option value="income">Entrada</option>
                            <option value="expense">Saída</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Valor (R$):</label>
                        <input type="number" id="amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Descrição:</label>
                        <input type="text" id="description" required>
                    </div>
                    <div class="form-group">
                        <label for="category">Categoria:</label>
                        <select id="category">
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="date">Data:</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="frequency">Frequência:</label>
                        <select id="frequency" required>
                            <option value="unique">Única</option>
                            <option value="monthly">Mensal</option>
                        </select>
                    </div>
                    <button type="submit">Adicionar</button>
                </form>
            </div>

            <div class="actions">
                <button id="importBtn">📤 Importar</button>
                <button id="exportBtn">📥 Exportar</button>
                <input type="file" id="fileInput" accept=".json" style="display:none">
            </div>

            <div class="card">
                <h3 style="margin-top:0">Transações Pendentes</h3>
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Data</th>
                            <th>Frequência</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="paid" class="tab-content">
            <div class="card">
                <h3 style="margin-top:0">Transações Pagas</h3>
                <table id="paidTransactionsTable">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Data</th>
                            <th>Pago em</th>
                        </tr>
                    </thead>
                    <tbody id="paidTransactionsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <div class="card">
                <h3 style="margin-top:0">Gráfico de Transações</h3>
                <canvas id="transactionsChart"></canvas>
            </div>
            <div class="card">
                <h3 style="margin-top:0">Resumo por Categoria</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            
            <div class="card" id="calendar-card">
                <h3 style="margin-top:0">Calendário de Contas</h3>
                <div id="calendar-container">
                    <div id="calendar-header">
                        <button id="prevMonth">Mês Anterior</button>
                        <h4 id="currentMonthYear"></h4>
                        <button id="nextMonth">Próximo Mês</button>
                    </div>
                    <table id="calendar-grid">
                        <thead>
                            <tr>
                                <th>Dom</th>
                                <th>Seg</th>
                                <th>Ter</th>
                                <th>Qua</th>
                                <th>Qui</th>
                                <th>Sex</th>
                                <th>Sáb</th>
                            </tr>
                        </thead>
                        <tbody id="calendar-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="categories" class="tab-content">
            <div class="card">
                <h3 style="margin-top:0">Gerenciar Categorias</h3>
                <div class="form-group">
                    <label for="newCategoryName">Nova Categoria:</label>
                    <input type="text" id="newCategoryName" placeholder="Nome da categoria">
                </div>
                <button id="addCategoryBtn">Adicionar Categoria</button>
                <hr style="margin: 15px 0;">
                <h4 style="margin-top:0;">Categorias Cadastradas:</h4>
                <div id="categoryList">
                    </div>
            </div>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeEditModal()">✖</button>
                <h3 style="margin-top:0">Editar Transação</h3>
                <form id="editForm">
                    <input type="hidden" id="edit-id">
                    <div class="form-group">
                        <label for="edit-type">Tipo:</label>
                        <select id="edit-type" required>
                            <option value="income">Entrada</option>
                            <option value="expense">Saída</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-amount">Valor (R$):</label>
                        <input type="number" id="edit-amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-description">Descrição:</label>
                        <input type="text" id="edit-description" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-category">Categoria:</label>
                        <select id="edit-category">
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-date">Data:</label>
                        <input type="date" id="edit-date" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-frequency">Frequência:</label>
                        <select id="edit-frequency" required>
                            <option value="unique">Única</option>
                            <option value="monthly">Mensal</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button type="submit" style="flex:1;">Salvar</button>
                        <button type="button" id="cancelEdit" style="flex:1; background:#95a5a6;" onclick="closeEditModal()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="billDetailsModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeBillDetailsModal()">✖</button>
                <h3 id="billDetailsTitle">Contas para o dia</h3>
                <div id="billDetailsList">
                    </div>
                <p id="noBillsMessage" style="text-align: center; color: #888; display: none;">Nenhuma conta para este dia.</p>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let transactions = [];
        let paidTransactions = [];
        let categories = ["Alimentação", "Moradia", "Transporte", "Lazer", "Saúde", "Educação", "Salário", "Outros"]; // Categorias padrão
        let chart = null;
        let categoryChart = null;
        const PASSWORD = "123456"; // Senha padrão - você pode alterar

        // Variáveis do Calendário
        let currentCalendarDate = new Date(); // Data atual para o calendário

        // Elementos do DOM
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginPassword = document.getElementById('login-password');
        const loginMessage = document.getElementById('login-message');
        const categorySelect = document.getElementById('category');
        const editCategorySelect = document.getElementById('edit-category');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const categoryListDiv = document.getElementById('categoryList');

        // Elementos do Calendário
        const currentMonthYear = document.getElementById('currentMonthYear');
        const calendarBody = document.getElementById('calendar-body');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');

        // Elementos do Modal de Detalhes da Conta
        const billDetailsModal = document.getElementById('billDetailsModal');
        const billDetailsTitle = document.getElementById('billDetailsTitle');
        const billDetailsList = document.getElementById('billDetailsList');
        const noBillsMessage = document.getElementById('noBillsMessage');


        // Verificar se há dados salvos ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            document.getElementById('date').valueAsDate = new Date();
        });

        // Sistema de Login
        function checkLogin() {
            const loggedIn = localStorage.getItem('loggedIn') === 'true';
            if (loggedIn) {
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                loadData();
                populateCategorySelects(); // Popula categorias após carregar dados
                renderCategoryList(); // Renderiza a lista de categorias
                renderCalendar(); // Renderiza o calendário ao logar
            } else {
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
            }
        }

        loginBtn.addEventListener('click', function() {
            if (loginPassword.value === PASSWORD) {
                localStorage.setItem('loggedIn', 'true');
                loginMessage.textContent = '';
                checkLogin();
            } else {
                loginMessage.textContent = 'Senha incorreta!';
            }
        });

        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('loggedIn');
            checkLogin();
            loginPassword.value = '';
            loginMessage.textContent = '';
        });

        // Carregar dados
        function loadData() {
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            paidTransactions = JSON.parse(localStorage.getItem('paidTransactions')) || [];
            categories = JSON.parse(localStorage.getItem('categories')) || ["Alimentação", "Moradia", "Transporte", "Lazer", "Saúde", "Educação", "Salário", "Outros"];
            updateTransactions();
            updateBalance();
            renderCharts();
            renderCalendar(); // Renderiza o calendário após carregar dados
        }

        // Salvar dados
        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('paidTransactions', JSON.stringify(paidTransactions));
            localStorage.setItem('categories', JSON.stringify(categories)); // Salvar categorias
            updateTransactions();
            updateBalance();
            renderCharts();
            renderCalendar(); // Renderiza o calendário após salvar dados
        }

        // Gerenciar Categorias
        function loadCategories() {
            categories = JSON.parse(localStorage.getItem('categories')) || ["Alimentação", "Moradia", "Transporte", "Lazer", "Saúde", "Educação", "Salário", "Outros"];
        }

        function saveCategories() {
            localStorage.setItem('categories', JSON.stringify(categories));
            populateCategorySelects();
            renderCategoryList();
        }

        function populateCategorySelects() {
            categorySelect.innerHTML = '<option value="">Selecione...</option>';
            editCategorySelect.innerHTML = '<option value="">Selecione...</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);

                const editOption = document.createElement('option');
                editOption.value = cat;
                editOption.textContent = cat;
                editCategorySelect.appendChild(editOption);
            });
        }

        addCategoryBtn.addEventListener('click', function() {
            const newCategory = newCategoryNameInput.value.trim();
            if (newCategory && !categories.includes(newCategory)) {
                categories.push(newCategory);
                saveCategories();
                newCategoryNameInput.value = '';
            } else if (newCategory) {
                alert('Esta categoria já existe!');
            }
        });

        function deleteCategory(categoryToDelete) {
            if (confirm(`Tem certeza que deseja excluir a categoria "${categoryToDelete}"? Todas as transações associadas a ela ficarão sem categoria definida.`)) {
                categories = categories.filter(cat => cat !== categoryToDelete);
                
                // Remover categoria de transações existentes
                transactions.forEach(t => {
                    if (t.category === categoryToDelete) {
                        t.category = ''; // Limpa a categoria
                    }
                });
                paidTransactions.forEach(t => {
                    if (t.category === categoryToDelete) {
                        t.category = ''; // Limpa a categoria
                    }
                });

                saveData(); // Salva as transações e as categorias
                saveCategories(); // Atualiza os selects e a lista
            }
        }

        function renderCategoryList() {
            categoryListDiv.innerHTML = '';
            if (categories.length === 0) {
                categoryListDiv.innerHTML = '<p>Nenhuma categoria cadastrada ainda.</p>';
                return;
            }
            categories.forEach(cat => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.innerHTML = `
                    <span>${cat}</span>
                    <button class="delete-btn" onclick="deleteCategory('${cat}')">❌</button>
                `;
                categoryListDiv.appendChild(categoryItem);
            });
        }

        // Formulário de transação
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const transaction = {
                id: Date.now(),
                type: document.getElementById('type').value,
                amount: parseFloat(document.getElementById('amount').value),
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                frequency: document.getElementById('frequency').value, // Nova propriedade
                paid: false
            };
            transactions.push(transaction);
            saveData();
            this.reset();
            document.getElementById('date').valueAsDate = new Date();
        });

        // Exportar dados
        document.getElementById('exportBtn').addEventListener('click', function() {
            const data = {
                transactions: transactions,
                paidTransactions: paidTransactions,
                categories: categories // Incluir categorias no export
            };
            const dataStr = JSON.stringify(data);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_financas_${new Date().toLocaleDateString('pt-BR')}.json`;
            a.click();
        });

        // Importar dados
        document.getElementById('importBtn').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm(`Importar ${imported.transactions.length || 0} transações pendentes, ${imported.paidTransactions.length || 0} pagas e ${imported.categories.length || 0} categorias?\n(Isso substituirá seus dados atuais)`)) {
                            transactions = imported.transactions || [];
                            paidTransactions = imported.paidTransactions || [];
                            categories = imported.categories || ["Alimentação", "Moradia", "Transporte", "Lazer", "Saúde", "Educação", "Salário", "Outros"];
                            saveData();
                            populateCategorySelects(); // Atualiza selects após importar
                            renderCategoryList(); // Atualiza lista de categorias
                            alert('Dados importados com sucesso!'); // Feedback de sucesso
                        }
                    } catch (error) {
                        alert('Erro ao importar arquivo. Verifique se o arquivo é um JSON válido e não foi modificado.');
                        console.error('Erro na importação:', error); // Log detalhado para depuração
                    } finally {
                        // Limpa o input de arquivo para permitir a mesma seleção novamente
                        e.target.value = ''; 
                    }
                };
                reader.readAsText(file);
            }
        });

        // Atualizar listas de transações
        function updateTransactions() {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            transactions
                .filter(t => !t.paid)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="${t.type}">${t.type === 'income' ? '⬆️' : '⬇️'} ${t.type === 'income' ? 'Entrada' : 'Saída'}</td>
                        <td class="${t.type}">R$ ${t.amount.toFixed(2)}</td>
                        <td>${t.description}</td>
                        <td>${t.category || '-'}</td>
                        <td>${new Date(t.date).toLocaleDateString()}</td>
                        <td>${t.frequency === 'monthly' ? 'Mensal' : 'Única'}</td>
                        <td style="white-space: nowrap;">
                            <button class="edit-btn" onclick="editTransaction(${t.id})" style="padding: 5px; margin-right: 5px;">✏️</button>
                            ${t.type === 'expense' ? `<button class="pay-btn" onclick="markAsPaid(${t.id})" style="padding: 5px; margin-right: 5px;">✔️</button>` : ''}
                            <button class="delete-btn" onclick="deleteTransaction(${t.id})" style="padding: 5px;">❌</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            const paidTbody = document.getElementById('paidTransactionsBody');
            paidTbody.innerHTML = '';
            
            paidTransactions
                .sort((a, b) => new Date(b.paidDate) - new Date(a.paidDate))
                .forEach(t => {
                    const row = document.createElement('tr');
                    row.className = 'paid';
                    row.innerHTML = `
                        <td class="${t.type}">${t.type === 'income' ? '⬆️' : '⬇️'} ${t.type === 'income' ? 'Entrada' : 'Saída'}</td>
                        <td class="${t.type}">R$ ${t.amount.toFixed(2)}</td>
                        <td>${t.description}</td>
                        <td>${t.category || '-'}</td>
                        <td>${new Date(t.date).toLocaleDateString()}</td>
                        <td>${new Date(t.paidDate).toLocaleDateString()}</td>
                    `;
                    paidTbody.appendChild(row);
                });
        }

        // Atualizar saldo
        function updateBalance() {
            const income = transactions
                .filter(t => !t.paid && t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = transactions
                .filter(t => !t.paid && t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = income - expense;
            
            const balanceElement = document.getElementById('totalBalance');
            balanceElement.textContent = `R$ ${balance.toFixed(2)}`;
            balanceElement.className = balance >= 0 ? 'positive' : 'negative';
        }

        // Renderizar gráficos
        function renderCharts() {
            renderTransactionsChart();
            renderCategoryChart();
        }

        function renderTransactionsChart() {
            const ctx = document.getElementById('transactionsChart').getContext('2d');
            
            // Agrupar por mês
            const monthlyData = {};
            
            // Incluir transações pendentes e pagas no cálculo do gráfico
            [...transactions, ...paidTransactions].forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getMonth()+1}/${date.getFullYear()}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }
                
                if (t.type === 'income') {
                    monthlyData[monthYear].income += t.amount;
                } else {
                    monthlyData[monthYear].expense += t.amount;
                }
            });
            
            const labels = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                return yearA - yearB || monthA - monthB;
            });
            
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: labels.map(l => monthlyData[l].income),
                            backgroundColor: '#2ecc71'
                        },
                        {
                            label: 'Saídas',
                            data: labels.map(l => monthlyData[l].expense),
                            backgroundColor: '#e74c3c'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Agrupar por categoria apenas despesas
            const categoryData = {};
            
            // Incluir todas as despesas, sejam elas pendentes ou pagas
            [...transactions.filter(t => t.type === 'expense'), ...paidTransactions.filter(t => t.type === 'expense')].forEach(t => {
                const category = t.category || 'Outros';
                categoryData[category] = (categoryData[category] || 0) + t.amount;
            });
            
            const labels = Object.keys(categoryData);
            const data = labels.map(l => categoryData[l]);
            
            if (categoryChart) categoryChart.destroy();
            
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', 
                            '#9b59b6', '#1abc9c', '#d35400', '#34495e',
                            '#95a5a6', '#f1c40f', '#ecf0f1', '#7f8c8d' // Mais cores
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Funções de ação
        function deleteTransaction(id) {
            if (confirm('Excluir esta transação permanentemente?')) {
                transactions = transactions.filter(t => t.id !== id);
                paidTransactions = paidTransactions.filter(t => t.id !== id);
                saveData();
            }
        }

        function markAsPaid(id) {
            const transactionIndex = transactions.findIndex(t => t.id === id);
            if (transactionIndex !== -1) {
                const transaction = transactions[transactionIndex];
                
                // Se for mensal, remove da lista de pendentes e cria uma nova para o próximo mês
                if (transaction.frequency === 'monthly') {
                    // Marca a transação atual como paga e move para paidTransactions
                    transaction.paid = true;
                    transaction.paidDate = new Date().toISOString().split('T')[0];
                    paidTransactions.push(transaction);

                    // Cria uma nova transação para o próximo mês
                    const nextMonthDate = new Date(transaction.date);
                    nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);

                    const newTransaction = {
                        ...transaction,
                        id: Date.now(), // Novo ID para a nova transação
                        date: nextMonthDate.toISOString().split('T')[0],
                        paid: false,
                        paidDate: null
                    };
                    transactions.splice(transactionIndex, 1); // Remove a transação original
                    transactions.push(newTransaction); // Adiciona a nova transação
                } else {
                    // Transação única: marca como paga e move
                    transaction.paid = true;
                    transaction.paidDate = new Date().toISOString().split('T')[0];
                    paidTransactions.push(transaction);
                    transactions.splice(transactionIndex, 1);
                }
                saveData();
            }
        }

        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id) || paidTransactions.find(t => t.id === id);
            if (transaction) {
                document.getElementById('edit-id').value = transaction.id;
                document.getElementById('edit-type').value = transaction.type;
                document.getElementById('edit-amount').value = transaction.amount;
                document.getElementById('edit-description').value = transaction.description;
                // Popula o select de categoria antes de definir o valor
                populateCategorySelects(); 
                document.getElementById('edit-category').value = transaction.category || '';
                document.getElementById('edit-date').value = transaction.date;
                document.getElementById('edit-frequency').value = transaction.frequency || 'unique'; // Define a frequência
                document.getElementById('editModal').style.display = 'flex';
            }
        }

        // Modal de edição
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('edit-id').value);
            let transactionToUpdate = null;
            let isPaidTransaction = false;

            let transactionIndex = transactions.findIndex(t => t.id === id);
            if (transactionIndex !== -1) {
                transactionToUpdate = transactions[transactionIndex];
            } else {
                transactionIndex = paidTransactions.findIndex(t => t.id === id);
                if (transactionIndex !== -1) {
                    transactionToUpdate = paidTransactions[transactionIndex];
                    isPaidTransaction = true;
                }
            }
            
            if (transactionToUpdate) {
                transactionToUpdate.type = document.getElementById('edit-type').value;
                transactionToUpdate.amount = parseFloat(document.getElementById('edit-amount').value);
                transactionToUpdate.description = document.getElementById('edit-description').value;
                transactionToUpdate.category = document.getElementById('edit-category').value;
                transactionToUpdate.date = document.getElementById('edit-date').value;
                transactionToUpdate.frequency = document.getElementById('edit-frequency').value; // Atualiza a frequência
                
                saveData();
                document.getElementById('editModal').style.display = 'none';
            }
        });

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Ativar botão
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // Mostrar conteúdo
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');

                // Renderizar a lista de categorias quando a aba de categorias for ativada
                if (tabId === 'categories') {
                    renderCategoryList();
                }
                // Renderizar o calendário se a aba de relatórios for ativada
                if (tabId === 'reports') {
                    renderCalendar();
                }
            });
        });

        // Funções do Calendário
        function renderCalendar() {
            calendarBody.innerHTML = ''; // Limpa o calendário existente
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth(); // 0-11
            
            // Define o texto do cabeçalho do calendário (ex: Julho 2024)
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            currentMonthYear.textContent = `${monthNames[month]} ${year}`;

            // Encontra o primeiro dia do mês (0 = Domingo, 1 = Segunda...)
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            // Encontra o último dia do mês
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let date = 1;
            // Loop para criar as semanas (linhas da tabela)
            for (let i = 0; i < 6; i++) { // 6 semanas para garantir que todos os dias caibam
                const row = document.createElement('tr');

                // Loop para criar os dias da semana (células da tabela)
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    let cellDate = null;

                    if (i === 0 && j < firstDayOfMonth) {
                        // Dias do mês anterior
                        cell.classList.add('other-month');
                        // cell.textContent = ''; // Deixa vazio ou mostra dias do mês anterior
                    } else if (date > daysInMonth) {
                        // Dias do próximo mês
                        cell.classList.add('other-month');
                        // cell.textContent = ''; // Deixa vazio ou mostra dias do próximo mês
                        date++;
                    } else {
                        // Dias do mês atual
                        cell.textContent = date;
                        cell.classList.add('current-month');
                        cellDate = new Date(year, month, date);

                        // Adiciona o evento de clique para mostrar detalhes das contas
                        cell.onclick = () => showBillsForDay(cellDate);

                        // Verifica se é o dia de hoje
                        const today = new Date();
                        if (cellDate.toDateString() === today.toDateString()) {
                            cell.classList.add('today');
                        }

                        // Verifica se há contas a pagar neste dia
                        const billsOnThisDay = getBillsForDate(cellDate);
                        if (billsOnThisDay.length > 0) {
                            cell.classList.add('has-bill');
                            // Adiciona um indicador visual
                            const indicator = document.createElement('div');
                            indicator.className = 'bill-indicator';
                            indicator.textContent = `(${billsOnThisDay.length} conta${billsOnThisDay.length > 1 ? 's' : ''})`;
                            cell.appendChild(indicator);
                        }
                        date++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
                if (date > daysInMonth && i > 3) break; // Para de adicionar linhas se já passou do último dia
            }
        }

        // Função para obter contas para uma data específica
        function getBillsForDate(targetDate) {
            const formattedTargetDate = targetDate.toISOString().split('T')[0]; // Formato YYYY-MM-DD
            
            // Filtra despesas pendentes e despesas pagas para o dia
            const allExpensesForDay = [
                ...transactions.filter(t => t.type === 'expense' && !t.paid && t.date === formattedTargetDate),
                ...paidTransactions.filter(t => t.type === 'expense' && t.date === formattedTargetDate)
            ];

            return allExpensesForDay;
        }

        // Função para mostrar detalhes das contas em um modal
        function showBillsForDay(date) {
            const bills = getBillsForDate(date);
            const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            billDetailsTitle.textContent = `Contas para ${formattedDate}`;
            billDetailsList.innerHTML = ''; // Limpa a lista anterior
            noBillsMessage.style.display = 'none'; // Esconde a mensagem de "nenhuma conta"

            if (bills.length === 0) {
                noBillsMessage.style.display = 'block';
            } else {
                bills.forEach(bill => {
                    const billItem = document.createElement('div');
                    billItem.className = 'bill-item';
                    const status = bill.paid ? ' (Paga)' : ' (Pendente)';
                    billItem.innerHTML = `
                        <strong>${bill.description}</strong>
                        <span>R$ ${bill.amount.toFixed(2)} - Categoria: ${bill.category || 'N/A'}${status}</span>
                    `;
                    billDetailsList.appendChild(billItem);
                });
            }
            billDetailsModal.style.display = 'flex'; // Mostra o modal
        }

        // Função para fechar o modal de detalhes das contas
        function closeBillDetailsModal() {
            billDetailsModal.style.display = 'none';
        }

        // Event Listeners para navegação do calendário
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });


        // Funções globais para os botões
        window.deleteTransaction = deleteTransaction;
        window.markAsPaid = markAsPaid;
        window.editTransaction = editTransaction;
        window.deleteCategory = deleteCategory;
        window.closeEditModal = closeEditModal;
        window.showBillsForDay = showBillsForDay;
        window.closeBillDetailsModal = closeBillDetailsModal;
    </script>
</body>
</html>
